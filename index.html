<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会議一括管理</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            color: #0078d4;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e1e1e1;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: #0078d4;
            border-bottom-color: #0078d4;
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        .meeting-entry {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fafafa;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .form-row label {
            min-width: 80px;
            font-weight: 600;
        }
        
        .form-row input, .form-row select, .form-row textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .participants-input {
            min-height: 60px;
            resize: vertical;
        }
        
        .action-buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #0078d4;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #106ebe;
        }
        
        .btn-success {
            background-color: #107c10;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #0e6d0e;
        }
        
        .btn-danger {
            background-color: #d13438;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b12327;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .history-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-details {
            flex: 1;
        }
        
        .history-title {
            font-weight: bold;
            color: #333;
        }
        
        .history-info {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .checkbox {
            margin-right: 15px;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>会議一括管理アドイン</h1>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('create')">予定作成</button>
                <button class="tab-button" onclick="switchTab('history')">履歴・削除</button>
            </div>
            
            <!-- 予定作成タブ -->
            <div id="create-tab" class="tab-content active">
                <div class="input-section">
                    <button class="btn btn-secondary" onclick="addMeetingEntry()">会議エントリを追加</button>
                    <div id="meeting-entries"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="createAllMeetings()">全ての会議を作成</button>
                    <button class="btn btn-secondary" onclick="clearAllEntries()">クリア</button>
                </div>
            </div>
            
            <!-- 履歴・削除タブ -->
            <div id="history-tab" class="tab-content">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadHistory()">履歴を更新</button>
                    <button class="btn btn-danger" onclick="deleteSelectedMeetings()">選択した会議を削除</button>
                </div>
                
                <div id="history-list"></div>
            </div>
        </div>
        
        <div id="status-message"></div>
    </div>

    <script>
        // グローバル変数
        let accessToken = null;
        let meetingHistory = JSON.parse(localStorage.getItem('meetingHistory') || '[]');
        
        // Office初期化
        Office.onReady(() => {
            console.log('Office is ready');
            initializeAddin();
        });
        
        function initializeAddin() {
            addMeetingEntry(); // 初期エントリを追加
            loadHistory(); // 履歴を読み込み
        }
        
        // タブ切り替え
        function switchTab(tabName) {
            // タブボタンの状態更新
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // タブコンテンツの表示切り替え
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // 会議エントリを追加
        function addMeetingEntry() {
            const container = document.getElementById('meeting-entries');
            const entryCount = container.children.length + 1;
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'meeting-entry';
            entryDiv.innerHTML = `
                <h4>会議 ${entryCount}</h4>
                <div class="form-row">
                    <label>件名:</label>
                    <input type="text" class="subject-input" placeholder="XXXに関するMTG" required>
                </div>
                <div class="form-row">
                    <label>日付:</label>
                    <input type="date" class="date-input" required>
                    <label>開始:</label>
                    <input type="time" class="start-time-input" value="13:00" required>
                    <label>終了:</label>
                    <input type="time" class="end-time-input" value="14:00" required>
                </div>
                <div class="form-row">
                    <label>参加者:</label>
                    <textarea class="participants-input" placeholder="xxx1@xxx.com, xxx2@xxx.com, xxx3@xxx.com" required></textarea>
                </div>
                <div class="form-row">
                    <button class="btn btn-danger" onclick="removeMeetingEntry(this)">削除</button>
                </div>
            `;
            
            container.appendChild(entryDiv);
        }
        
        // 会議エントリを削除
        function removeMeetingEntry(button) {
            button.closest('.meeting-entry').remove();
        }
        
        // 全エントリをクリア
        function clearAllEntries() {
            document.getElementById('meeting-entries').innerHTML = '';
            addMeetingEntry(); // 最低1つは残す
        }
        
        // アクセストークンを取得
        async function getAccessToken() {
            if (accessToken) return accessToken;
            
            try {
                // Office.jsを使用してトークンを取得
                return new Promise((resolve, reject) => {
                    Office.context.auth.getAccessTokenAsync({ forceConsent: false }, (result) => {
                        if (result.status === "succeeded") {
                            accessToken = result.value;
                            resolve(accessToken);
                        } else {
                            reject(new Error("認証に失敗しました"));
                        }
                    });
                });
            } catch (error) {
                throw new Error("認証処理でエラーが発生しました: " + error.message);
            }
        }
        
        // 全ての会議を作成
        async function createAllMeetings() {
            const entries = document.querySelectorAll('.meeting-entry');
            if (entries.length === 0) {
                showMessage('会議エントリがありません', 'error');
                return;
            }
            
            showMessage('会議を作成中...', 'loading');
            
            try {
                const token = await getAccessToken();
                const results = [];
                
                for (let entry of entries) {
                    const subject = entry.querySelector('.subject-input').value;
                    const date = entry.querySelector('.date-input').value;
                    const startTime = entry.querySelector('.start-time-input').value;
                    const endTime = entry.querySelector('.end-time-input').value;
                    const participantsText = entry.querySelector('.participants-input').value;
                    
                    if (!subject || !date || !startTime || !endTime || !participantsText) {
                        continue;
                    }
                    
                    // 参加者をパース
                    const participants = participantsText.split(',')
                        .map(email => email.trim())
                        .filter(email => email)
                        .map(email => ({
                            emailAddress: {
                                address: email,
                                name: email.split('@')[0]
                            }
                        }));
                    
                    // 日時を作成
                    const startDateTime = new Date(`${date}T${startTime}:00`);
                    const endDateTime = new Date(`${date}T${endTime}:00`);
                    
                    const meetingData = {
                        subject: subject,
                        start: {
                            dateTime: startDateTime.toISOString(),
                            timeZone: "Asia/Tokyo"
                        },
                        end: {
                            dateTime: endDateTime.toISOString(),
                            timeZone: "Asia/Tokyo"
                        },
                        attendees: participants,
                        isOnlineMeeting: false,
                        showAs: "busy"
                    };
                    
                    // Graph APIで会議を作成
                    const response = await fetch('https://graph.microsoft.com/v1.0/me/events', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(meetingData)
                    });
                    
                    if (response.ok) {
                        const createdEvent = await response.json();
                        
                        // 履歴に保存
                        const historyItem = {
                            id: createdEvent.id,
                            subject: subject,
                            startTime: startDateTime.toISOString(),
                            endTime: endDateTime.toISOString(),
                            participants: participants.map(p => p.emailAddress.address),
                            createdAt: new Date().toISOString()
                        };
                        
                        meetingHistory.push(historyItem);
                        results.push(historyItem);
                    } else {
                        console.error('Failed to create meeting:', await response.text());
                    }
                }
                
                // ローカルストレージに保存
                localStorage.setItem('meetingHistory', JSON.stringify(meetingHistory));
                
                if (results.length > 0) {
                    showMessage(`${results.length}件の会議が正常に作成され、招待が送信されました`, 'success');
                    clearAllEntries();
                } else {
                    showMessage('会議の作成に失敗しました', 'error');
                }
                
            } catch (error) {
                console.error('Error creating meetings:', error);
                showMessage('エラーが発生しました: ' + error.message, 'error');
            }
        }
        
        // 履歴を読み込み
        function loadHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (meetingHistory.length === 0) {
                historyList.innerHTML = '<p class="loading">履歴がありません</p>';
                return;
            }
            
            // 新しい順にソート
            meetingHistory.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            meetingHistory.forEach((meeting, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const startDate = new Date(meeting.startTime);
                const endDate = new Date(meeting.endTime);
                const dateStr = startDate.toLocaleDateString('ja-JP');
                const timeStr = `${startDate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})} - ${endDate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}`;
                
                historyItem.innerHTML = `
                    <input type="checkbox" class="checkbox" data-meeting-id="${meeting.id}" data-index="${index}">
                    <div class="history-details">
                        <div class="history-title">${meeting.subject}</div>
                        <div class="history-info">
                            ${dateStr} ${timeStr}<br>
                            参加者: ${meeting.participants.join(', ')}
                        </div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        // 選択した会議を削除
        async function deleteSelectedMeetings() {
            const checkedBoxes = document.querySelectorAll('#history-list input[type="checkbox"]:checked');
            
            if (checkedBoxes.length === 0) {
                showMessage('削除する会議を選択してください', 'error');
                return;
            }
            
            if (!confirm(`${checkedBoxes.length}件の会議を削除しますか？`)) {
                return;
            }
            
            showMessage('会議を削除中...', 'loading');
            
            try {
                const token = await getAccessToken();
                let deletedCount = 0;
                
                for (let checkbox of checkedBoxes) {
                    const meetingId = checkbox.dataset.meetingId;
                    const index = parseInt(checkbox.dataset.index);
                    
                    // Graph APIで会議を削除
                    const response = await fetch(`https://graph.microsoft.com/v1.0/me/events/${meetingId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        // 履歴からも削除
                        meetingHistory.splice(index, 1);
                        deletedCount++;
                    } else {
                        console.error('Failed to delete meeting:', await response.text());
                    }
                }
                
                // ローカルストレージを更新
                localStorage.setItem('meetingHistory', JSON.stringify(meetingHistory));
                
                if (deletedCount > 0) {
                    showMessage(`${deletedCount}件の会議が削除されました`, 'success');
                    loadHistory(); // 履歴を再読み込み
                } else {
                    showMessage('会議の削除に失敗しました', 'error');
                }
                
            } catch (error) {
                console.error('Error deleting meetings:', error);
                showMessage('エラーが発生しました: ' + error.message, 'error');
            }
        }
        
        // ステータスメッセージを表示
        function showMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // 5秒後に自動で消去（エラー以外）
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>