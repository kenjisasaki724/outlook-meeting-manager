<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会議一括管理</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        h1 {
            color: #0078d4;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .tab-container {
            margin-bottom: 15px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e1e1e1;
        }
        
        .tab-button {
            padding: 8px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: #0078d4;
            border-bottom-color: #0078d4;
        }
        
        .tab-content {
            display: none;
            padding: 15px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            margin-bottom: 15px;
        }
        
        .meeting-entry {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fafafa;
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .form-row label {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        .form-row input, .form-row select, .form-row textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 13px;
        }
        
        .datetime-section {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        
        .datetime-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .datetime-item:last-child {
            margin-bottom: 0;
        }
        
        .datetime-item input[type="date"] {
            flex: 2;
        }
        
        .datetime-item input[type="time"] {
            flex: 1;
        }
        
        .datetime-item span {
            font-size: 12px;
        }
        
        .datetime-item .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .add-datetime-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .participants-input {
            min-height: 60px;
            resize: vertical;
        }
        
        .action-buttons {
            text-align: center;
            margin: 15px 0;
        }
        
        .btn {
            padding: 8px 15px;
            margin: 0 4px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #0078d4;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #106ebe;
        }
        
        .btn-success {
            background-color: #107c10;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #0e6d0e;
        }
        
        .btn-danger {
            background-color: #d13438;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b12327;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .history-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-details {
            flex: 1;
        }
        
        .history-title {
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }
        
        .history-info {
            color: #666;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .checkbox {
            margin-right: 10px;
        }
        
        .status-message {
            padding: 8px;
            margin: 8px 0;
            border-radius: 5px;
            text-align: center;
            font-size: 12px;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>会議一括管理アドイン</h1>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('create')">予定作成</button>
                <button class="tab-button" onclick="switchTab('history')">履歴・削除</button>
            </div>
            
            <!-- 予定作成タブ -->
            <div id="create-tab" class="tab-content active">
                <div class="input-section">
                    <button class="btn btn-secondary" onclick="addMeetingEntry()">会議エントリを追加</button>
                    <div id="meeting-entries"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="createAllMeetings()">全ての会議を作成</button>
                    <button class="btn btn-secondary" onclick="clearAllEntries()">クリア</button>
                </div>
            </div>
            
            <!-- 履歴・削除タブ -->
            <div id="history-tab" class="tab-content">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadHistory()">履歴を更新</button>
                    <button class="btn btn-danger" onclick="deleteSelectedMeetings()">選択した会議を削除</button>
                </div>
                
                <div id="history-list"></div>
            </div>
        </div>
        
        <div id="status-message"></div>
    </div>

    <script>
        // グローバル変数
        let accessToken = null;
        let meetingHistory = JSON.parse(localStorage.getItem('meetingHistory') || '[]');
        
        // Office初期化
        Office.onReady(() => {
            console.log('Office is ready');
            initializeAddin();
        });
        
        function initializeAddin() {
            addMeetingEntry(); // 初期エントリを追加
            loadHistory(); // 履歴を読み込み
        }
        
        // タブ切り替え
        function switchTab(tabName) {
            // タブボタンの状態更新
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // タブコンテンツの表示切り替え
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // 会議エントリを追加
        function addMeetingEntry() {
            const container = document.getElementById('meeting-entries');
            const entryCount = container.children.length + 1;
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'meeting-entry';
            entryDiv.innerHTML = `
                <h4>会議 ${entryCount}</h4>
                <div class="form-row">
                    <label>件名:</label>
                    <input type="text" class="subject-input" placeholder="XXXに関するMTG" required>
                </div>
                <div class="form-row">
                    <label>日時候補:</label>
                    <div class="datetime-section">
                        <div class="datetime-item">
                            <input type="date" class="date-input" required>
                            <input type="time" class="start-time-input" value="13:00" required>
                            <span>〜</span>
                            <input type="time" class="end-time-input" value="14:00" required>
                            <button type="button" class="remove-btn" onclick="removeDateTimeSlot(this)" style="display: none;">削除</button>
                        </div>
                    </div>
                    <button type="button" class="add-datetime-btn" onclick="addDateTimeSlot(this)">日時を追加</button>
                </div>
                <div class="form-row">
                    <label>参加者:</label>
                    <textarea class="participants-input" placeholder="xxx1@xxx.com, xxx2@xxx.com, xxx3@xxx.com" required rows="3"></textarea>
                </div>
                <div class="form-row">
                    <button class="btn btn-danger" onclick="removeMeetingEntry(this)">削除</button>
                </div>
            `;
            
            container.appendChild(entryDiv);
        }
        
        // 日時スロットを追加
        function addDateTimeSlot(button) {
            const datetimeSection = button.previousElementSibling;
            const newSlot = document.createElement('div');
            newSlot.className = 'datetime-item';
            newSlot.innerHTML = `
                <input type="date" class="date-input" required>
                <input type="time" class="start-time-input" value="13:00" required>
                <span>〜</span>
                <input type="time" class="end-time-input" value="14:00" required>
                <button type="button" class="remove-btn" onclick="removeDateTimeSlot(this)">削除</button>
            `;
            datetimeSection.appendChild(newSlot);
            
            // 最初のスロットの削除ボタンを表示
            const firstSlot = datetimeSection.querySelector('.datetime-item .remove-btn');
            if (firstSlot) {
                firstSlot.style.display = 'inline-block';
            }
        }
        
        // 日時スロットを削除
        function removeDateTimeSlot(button) {
            const datetimeSection = button.closest('.datetime-section');
            const slotCount = datetimeSection.querySelectorAll('.datetime-item').length;
            
            if (slotCount > 1) {
                button.closest('.datetime-item').remove();
                
                // 残りが1つになったら削除ボタンを非表示
                if (datetimeSection.querySelectorAll('.datetime-item').length === 1) {
                    const remainingBtn = datetimeSection.querySelector('.remove-btn');
                    if (remainingBtn) {
                        remainingBtn.style.display = 'none';
                    }
                }
            }
        }
        
        // 会議エントリを削除
        function removeMeetingEntry(button) {
            button.closest('.meeting-entry').remove();
        }
        
        // 全エントリをクリア
        function clearAllEntries() {
            document.getElementById('meeting-entries').innerHTML = '';
            addMeetingEntry(); // 最低1つは残す
        }
        
        // アクセストークンを取得
        async function getAccessToken() {
            if (accessToken) return accessToken;
            
            try {
                return new Promise((resolve, reject) => {
                    Office.context.auth.getAccessTokenAsync({ forceConsent: false }, (result) => {
                        if (result.status === "succeeded") {
                            accessToken = result.value;
                            resolve(accessToken);
                        } else {
                            reject(new Error("認証に失敗しました"));
                        }
                    });
                });
            } catch (error) {
                throw new Error("認証処理でエラーが発生しました: " + error.message);
            }
        }
        
        // 全ての会議を作成
        async function createAllMeetings() {
            const entries = document.querySelectorAll('.meeting-entry');
            if (entries.length === 0) {
                showMessage('会議エントリがありません', 'error');
                return;
            }
            
            showMessage('会議を作成中...', 'loading');
            
            try {
                const results = [];
                
                for (let entry of entries) {
                    const subject = entry.querySelector('.subject-input').value;
                    const participantsText = entry.querySelector('.participants-input').value;
                    const datetimeItems = entry.querySelectorAll('.datetime-item');
                    
                    if (!subject || !participantsText) {
                        continue;
                    }
                    
                    // 参加者をパース
                    const participants = participantsText.split(',')
                        .map(email => email.trim())
                        .filter(email => email)
                        .map(email => ({
                            emailAddress: {
                                address: email,
                                name: email.split('@')[0]
                            }
                        }));
                    
                    // 各日時候補に対して会議を作成
                    for (let datetimeItem of datetimeItems) {
                        const date = datetimeItem.querySelector('.date-input').value;
                        const startTime = datetimeItem.querySelector('.start-time-input').value;
                        const endTime = datetimeItem.querySelector('.end-time-input').value;
                        
                        if (!date || !startTime || !endTime) {
                            continue;
                        }
                        
                        // 日時を作成
                        const startDateTime = new Date(`${date}T${startTime}:00`);
                        const endDateTime = new Date(`${date}T${endTime}:00`);
                        
                        const historyItem = {
                            id: Date.now() + Math.random(), // 仮のID
                            subject: subject,
                            startTime: startDateTime.toISOString(),
                            endTime: endDateTime.toISOString(),
                            participants: participants.map(p => p.emailAddress.address),
                            createdAt: new Date().toISOString()
                        };
                        
                        meetingHistory.push(historyItem);
                        results.push(historyItem);
                    }
                }
                
                // ローカルストレージに保存
                localStorage.setItem('meetingHistory', JSON.stringify(meetingHistory));
                
                if (results.length > 0) {
                    showMessage(`${results.length}件の会議が正常に作成されました（テスト環境）`, 'success');
                    clearAllEntries();
                } else {
                    showMessage('会議の作成に失敗しました', 'error');
                }
                
            } catch (error) {
                console.error('Error creating meetings:', error);
                showMessage('エラーが発生しました: ' + error.message, 'error');
            }
        }
        
        // 履歴を読み込み
        function loadHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (meetingHistory.length === 0) {
                historyList.innerHTML = '<p class="loading">履歴がありません</p>';
                return;
            }
            
            // 新しい順にソート
            meetingHistory.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            meetingHistory.forEach((meeting, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const startDate = new Date(meeting.startTime);
                const endDate = new Date(meeting.endTime);
                const dateStr = startDate.toLocaleDateString('ja-JP');
                const timeStr = `${startDate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})} - ${endDate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}`;
                
                historyItem.innerHTML = `
                    <input type="checkbox" class="checkbox" data-meeting-id="${meeting.id}" data-index="${index}">
                    <div class="history-details">
                        <div class="history-title">${meeting.subject}</div>
                        <div class="history-info">
                            ${dateStr} ${timeStr}<br>
                            参加者: ${meeting.participants.join(', ')}
                        </div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        // 選択した会議を削除
        async function deleteSelectedMeetings() {
            const checkedBoxes = document.querySelectorAll('#history-list input[type="checkbox"]:checked');
            
            if (checkedBoxes.length === 0) {
                showMessage('削除する会議を選択してください', 'error');
                return;
            }
            
            if (!confirm(`${checkedBoxes.length}件の会議を削除しますか？`)) {
                return;
            }
            
            showMessage('会議を削除中...', 'loading');
            
            try {
                let deletedCount = 0;
                const indexesToDelete = [];
                
                for (let checkbox of checkedBoxes) {
                    const index = parseInt(checkbox.dataset.index);
                    indexesToDelete.push(index);
                    deletedCount++;
                }
                
                // インデックスを逆順でソートして削除（配列のインデックスがずれないように）
                indexesToDelete.sort((a, b) => b - a);
                for (let index of indexesToDelete) {
                    meetingHistory.splice(index, 1);
                }
                
                // ローカルストレージを更新
                localStorage.setItem('meetingHistory', JSON.stringify(meetingHistory));
                
                showMessage(`${deletedCount}件の会議が削除されました（テスト環境）`, 'success');
                loadHistory(); // 履歴を再読み込み
                
            } catch (error) {
                console.error('Error deleting meetings:', error);
                showMessage('エラーが発生しました: ' + error.message, 'error');
            }
        }
        
        // ステータスメッセージを表示
        function showMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // 5秒後に自動で消去（エラー以外）
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>
